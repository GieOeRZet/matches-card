// ============================================================================
//  League Table Card Editor – v0.1.000
//  - Powiązany z league-table-card
//  - Debounce ~700 ms dla inputów
//  - Sekcje: Podstawy, Czcionki, Podświetlenia
// ============================================================================

(function () {
  const DEFAULT_CONFIG = {
    name: "Tabela ligowa",
    show_name: true,
    lite_mode: false,
    show_trend: true,

    font_size: {
      header: 0.8,
      row: 0.9,
      team: 1.0,
    },

    highlight: {
      favorite: true,
      top_count: 3,
      bottom_count: 3,
      favorite_color: "#fff8e1",
      top_color: "#e8f5e9",
      bottom_color: "#ffebee",
    },
  };

  const deepMerge = (target, source) => {
    if (!source) return target;
    Object.keys(source).forEach((key) => {
      const sv = source[key];
      if (sv && typeof sv === "object" && !Array.isArray(sv)) {
        if (!target[key] || typeof target[key] !== "object") {
          target[key] = {};
        }
        deepMerge(target[key], sv);
      } else {
        target[key] = sv;
      }
    });
    return target;
  };

  class LeagueTableCardEditor extends HTMLElement {
    constructor() {
      super();
      this._config = {};
      this._debouncers = {};
    }

    setConfig(config) {
      this._config = config || {};
      this._render();
    }

    set hass(hass) {
      this._hass = hass;
    }

    _effectiveConfig() {
      const base = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
      return deepMerge(base, this._config || {});
    }

    _dispatchConfig(config) {
      const ev = new Event("config-changed", {
        bubbles: true,
        composed: true,
      });
      ev.detail = { config };
      this.dispatchEvent(ev);
    }

    _updatePath(path, value) {
      const cfg = JSON.parse(JSON.stringify(this._config || {}));
      const keys = Array.isArray(path) ? path : String(path).split(".");
      let obj = cfg;
      for (let i = 0; i < keys.length - 1; i++) {
        const k = keys[i];
        if (!obj[k] || typeof obj[k] !== "object") {
          obj[k] = {};
        }
        obj = obj[k];
      }
      obj[keys[keys.length - 1]] = value;
      this._config = cfg;
      this._dispatchConfig(cfg);
    }

    _debouncedUpdate(path, value) {
      const key = Array.isArray(path) ? path.join(".") : String(path);
      if (this._debouncers[key]) {
        clearTimeout(this._debouncers[key]);
      }
      this._debouncers[key] = setTimeout(() => {
        this._updatePath(path, value);
      }, 700);
    }

    _bindInput(selector, path, parser = (v) => v, debounced = true) {
      const el = this.querySelector(selector);
      if (!el) return;
      el.addEventListener("input", (ev) => {
        const v = parser(ev.target.value);
        if (debounced) this._debouncedUpdate(path, v);
        else this._updatePath(path, v);
      });
    }

    _bindCheckbox(selector, path) {
      const el = this.querySelector(selector);
      if (!el) return;
      el.addEventListener("change", (ev) => {
        this._updatePath(path, ev.target.checked);
      });
    }

    _render() {
      const cfg = this._effectiveConfig();

      this.innerHTML = `
        <style>
          .ltce-root {
            padding: 16px;
            font-family: var(--paper-font-body1_-_font-family, inherit);
          }
          .ltce-section {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--divider-color, #ccc);
          }
          .ltce-section:last-of-type {
            border-bottom: none;
          }
          .ltce-section h3 {
            margin: 0 0 10px;
            font-size: 1.05rem;
            font-weight: 600;
          }
          .ltce-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px 18px;
          }
          .ltce-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
          }
          .ltce-field label {
            font-size: 0.85rem;
            opacity: 0.9;
          }
          .ltce-checkbox {
            width: 16px;
            height: 16px;
          }
          .ltce-input,
          .ltce-number,
          .ltce-select {
            width: 100%;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid var(--divider-color, #aaa);
            background: var(--card-background-color, #fff);
            color: var(--primary-text-color, #000);
          }
          .ltce-number {
            text-align: right;
          }
          .ltce-color {
            width: 48px;
            height: 28px;
            border-radius: 4px;
            border: 1px solid var(--divider-color, #aaa);
          }
          .ltce-note {
            font-size: 0.75rem;
            opacity: 0.7;
          }
        </style>

        <div class="ltce-root">

          <!-- PODSTAWY -->
          <div class="ltce-section">
            <h3>Podstawy</h3>
            <div class="ltce-grid">

              <div class="ltce-field">
                <label>Encja sensora</label>
                <input id="ltce-entity" class="ltce-input" value="${cfg.entity || ""}">
              </div>

              <div class="ltce-field">
                <label>Nazwa karty (header)</label>
                <input id="ltce-name" class="ltce-input" value="${cfg.name}">
              </div>

              <div class="ltce-field">
                <label>
                  <input id="ltce-show-name" class="ltce-checkbox" type="checkbox"
                    ${cfg.show_name ? "checked" : ""}>
                  Pokaż nazwę karty
                </label>
              </div>

              <div class="ltce-field">
                <label>
                  <input id="ltce-lite-mode" class="ltce-checkbox" type="checkbox"
                    ${cfg.lite_mode ? "checked" : ""}>
                  Tryb LITE (bez tła ha-card)
                </label>
              </div>

              <div class="ltce-field">
                <label>
                  <input id="ltce-show-trend" class="ltce-checkbox" type="checkbox"
                    ${cfg.show_trend ? "checked" : ""}>
                  Pokaż kolumnę TREND
                </label>
                <div class="ltce-note">
                  TREND korzysta z pola <code>trend</code> w każdym wierszu tabeli (opcjonalne).
                </div>
              </div>

            </div>
          </div>

          <!-- CZCIONKI -->
          <div class="ltce-section">
            <h3>Czcionki</h3>
            <div class="ltce-grid">

              <div class="ltce-field">
                <label>Nagłówek kolumn – font-size (rem)</label>
                <input id="ltce-font-header" class="ltce-number" type="number"
                  step="0.1" value="${cfg.font_size.header}">
              </div>

              <div class="ltce-field">
                <label>Wiersze – font-size (rem)</label>
                <input id="ltce-font-row" class="ltce-number" type="number"
                  step="0.1" value="${cfg.font_size.row}">
              </div>

              <div class="ltce-field">
                <label>Nazwa drużyny – font-size (rem)</label>
                <input id="ltce-font-team" class="ltce-number" type="number"
                  step="0.1" value="${cfg.font_size.team}">
              </div>

            </div>
          </div>

          <!-- PODŚWIETLENIA -->
          <div class="ltce-section">
            <h3>Podświetlenia – TOP / spadkowe / moja drużyna</h3>
            <div class="ltce-grid">

              <div class="ltce-field">
                <label>
                  <input id="ltce-highlight-favorite" class="ltce-checkbox" type="checkbox"
                    ${cfg.highlight.favorite ? "checked" : ""}>
                  Podświetl moją drużynę
                </label>
                <div class="ltce-note">
                  Moja drużyna = wiersz o pozycji <code>my_position</code> z sensora.
                </div>
              </div>

              <div class="ltce-field">
                <label>TOP – ile pierwszych drużyn podświetlić</label>
                <input id="ltce-highlight-top-count" class="ltce-number" type="number"
                  min="0" max="10" step="1" value="${cfg.highlight.top_count}">
              </div>

              <div class="ltce-field">
                <label>SPADKOWE – ile ostatnich drużyn podświetlić</label>
                <input id="ltce-highlight-bottom-count" class="ltce-number" type="number"
                  min="0" max="10" step="1" value="${cfg.highlight.bottom_count}">
              </div>

              <div class="ltce-field">
                <label>Kolor mojej drużyny</label>
                <input id="ltce-highlight-favorite-color" class="ltce-color"
                  type="color" value="${cfg.highlight.favorite_color}">
              </div>

              <div class="ltce-field">
                <label>Kolor TOP</label>
                <input id="ltce-highlight-top-color" class="ltce-color"
                  type="color" value="${cfg.highlight.top_color}">
              </div>

              <div class="ltce-field">
                <label>Kolor SPADKOWE</label>
                <input id="ltce-highlight-bottom-color" class="ltce-color"
                  type="color" value="${cfg.highlight.bottom_color}">
              </div>

            </div>
          </div>

        </div>
      `;

      // POWIĄZANIA

      // podstawy
      this._bindInput("#ltce-entity", "entity", (v) => v);
      this._bindInput("#ltce-name", "name", (v) => v);
      this._bindCheckbox("#ltce-show-name", "show_name");
      this._bindCheckbox("#ltce-lite-mode", "lite_mode");
      this._bindCheckbox("#ltce-show-trend", "show_trend");

      // fonty
      this._bindInput(
        "#ltce-font-header",
        "font_size.header",
        (v) => parseFloat(v || "0")
      );
      this._bindInput(
        "#ltce-font-row",
        "font_size.row",
        (v) => parseFloat(v || "0")
      );
      this._bindInput(
        "#ltce-font-team",
        "font_size.team",
        (v) => parseFloat(v || "0")
      );

      // highlight
      this._bindCheckbox("#ltce-highlight-favorite", "highlight.favorite");
      this._bindInput(
        "#ltce-highlight-top-count",
        "highlight.top_count",
        (v) => parseInt(v || "0", 10)
      );
      this._bindInput(
        "#ltce-highlight-bottom-count",
        "highlight.bottom_count",
        (v) => parseInt(v || "0", 10)
      );
      this._bindInput(
        "#ltce-highlight-favorite-color",
        "highlight.favorite_color",
        (v) => v
      );
      this._bindInput(
        "#ltce-highlight-top-color",
        "highlight.top_color",
        (v) => v
      );
      this._bindInput(
        "#ltce-highlight-bottom-color",
        "highlight.bottom_color",
        (v) => v
      );
    }
  }

  if (!customElements.get("league-table-card-editor")) {
    customElements.define("league-table-card-editor", LeagueTableCardEditor);
  }
})();