// ============================================================================
//  League Table Card (90minut) – v0.1.000
//  Author: GieOeRZet
//  Dane z sensora: attributes.table[], my_position, my_points, my_goal_diff
//  - Spójny layout z Matches Card
//  - Podświetlenie: TOP / dół / moja drużyna
//  - Ostatnia kolumna: TREND (opcjonalne pole "trend" w każdym wierszu)
//  - Tryb LITE: bez <ha-card>, samo <table>
// ============================================================================

class LeagueTableCard extends HTMLElement {
  setConfig(config) {
    if (!config.entity) {
      throw new Error(
        "Entity is required (np. sensor.90minut_gornik_zabrze_table)"
      );
    }

    const defaults = {
      name: "Tabela ligowa",
      show_name: true,
      lite_mode: false,
      show_trend: true,

      font_size: {
        header: 0.8,
        row: 0.9,
        team: 1.0,
      },

      highlight: {
        favorite: true,
        top_count: 3,
        bottom_count: 3,
        favorite_color: "#fff8e1", // delikatny żółty
        top_color: "#e8f5e9",      // delikatny zielony
        bottom_color: "#ffebee",   // delikatny czerwony
      },
    };

    this.config = {
      ...defaults,
      ...config,
      font_size: { ...defaults.font_size, ...(config.font_size || {}) },
      highlight: { ...defaults.highlight, ...(config.highlight || {}) },
    };

    this.entityId = config.entity;
  }

  set hass(hass) {
    this._hass = hass;
    this._render();
  }

  _render() {
    if (!this._hass || !this.entityId) return;

    const stateObj = this._hass.states[this.entityId];
    if (!stateObj) {
      this.innerHTML = "<ha-card>Błąd: encja nie istnieje.</ha-card>";
      return;
    }

    const table = stateObj.attributes.table || [];
    const totalTeams = table.length || 0;
    const myPosAttr = stateObj.attributes.my_position;
    const myPosition = myPosAttr != null ? parseInt(myPosAttr, 10) : null;

    const cfg = this.config;

    const style = `
      <style>
        .ltc-card {
          font-family: "Sofascore Sans", Arial, sans-serif;
        }
        table.ltc-table {
          width: 100%;
          border-collapse: collapse;
        }
        .ltc-table th,
        .ltc-table td {
          padding: 4px 6px;
          border-bottom: 1px solid rgba(0,0,0,0.08);
          font-size: ${cfg.font_size.row}rem;
          text-align: center;
          vertical-align: middle;
          white-space: nowrap;
        }
        .ltc-table th {
          font-weight: 600;
          font-size: ${cfg.font_size.header}rem;
          opacity: 0.8;
        }
        .ltc-col-pos   { width: 10%; text-align: right; }
        .ltc-col-team  { text-align: left; font-size: ${cfg.font_size.team}rem; }
        .ltc-col-m     { width: 8%;  }
        .ltc-col-pkt   { width: 10%; font-weight: 600; }
        .ltc-col-goals { width: 14%; }
        .ltc-col-diff  { width: 10%; }
        .ltc-col-trend { width: 10%; }

        .ltc-row-favorite {
          background-color: ${cfg.highlight.favorite_color};
        }
        .ltc-row-top {
          background-color: ${cfg.highlight.top_color};
        }
        .ltc-row-bottom {
          background-color: ${cfg.highlight.bottom_color};
        }

        .ltc-team-name {
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .ltc-trend-up {
          color: var(--success-color, #2e7d32);
        }
        .ltc-trend-down {
          color: var(--error-color, #c62828);
        }
        .ltc-trend-same {
          color: var(--secondary-text-color, #808080);
        }
      </style>
    `;

    const rowsHTML = table
      .map((row) => this._renderRow(row, myPosition, totalTeams))
      .join("");

    const headerHTML = `
      <thead>
        <tr>
          <th class="ltc-col-pos">Poz</th>
          <th class="ltc-col-team">Drużyna</th>
          <th class="ltc-col-m">M</th>
          <th class="ltc-col-pkt">Pkt</th>
          <th class="ltc-col-goals">Bramki</th>
          <th class="ltc-col-diff">+/-</th>
          ${
            this.config.show_trend
              ? `<th class="ltc-col-trend">Trend</th>`
              : ""
          }
        </tr>
      </thead>
    `;

    const tableHTML = `
      ${style}
      <div class="ltc-card">
        <table class="ltc-table">
          ${headerHTML}
          <tbody>
            ${rowsHTML}
          </tbody>
        </table>
      </div>
    `;

    if (this.config.lite_mode) {
      this.innerHTML = tableHTML;
      return;
    }

    const cardName =
      this.config.show_name === false
        ? ""
        : this.config.name ||
          stateObj.attributes.friendly_name ||
          "Tabela ligowa";

    this.innerHTML = `
      ${style}
      <ha-card ${cardName ? `header="${cardName}"` : ""}>
        ${tableHTML}
      </ha-card>
    `;
  }

  _renderRow(row, myPosition, totalTeams) {
    const cfg = this.config;
    const pos = row.position ? parseInt(row.position, 10) : null;

    const isFavorite =
      cfg.highlight.favorite && myPosition != null && pos === myPosition;
    const isTop =
      cfg.highlight.top_count > 0 &&
      pos != null &&
      pos >= 1 &&
      pos <= cfg.highlight.top_count;
    const isBottom =
      cfg.highlight.bottom_count > 0 &&
      pos != null &&
      totalTeams > 0 &&
      pos > totalTeams - cfg.highlight.bottom_count;

    let rowClass = "";
    if (isFavorite) {
      rowClass = "ltc-row-favorite";
    } else if (isTop) {
      rowClass = "ltc-row-top";
    } else if (isBottom) {
      rowClass = "ltc-row-bottom";
    }

    const matches = row.matches ?? "-";
    const points = row.points ?? "-";
    const goals = row.goals ?? "-";

    let diff = row.diff;
    let diffStr = "-";
    if (diff !== undefined && diff !== null && diff !== "") {
      const n = typeof diff === "number" ? diff : parseInt(diff, 10);
      if (!isNaN(n)) {
        diffStr = (n > 0 ? "+" : "") + n;
      } else {
        diffStr = String(diff);
      }
    }

    const teamName = row.team || "";

    let trendHTML = "";
    if (cfg.show_trend) {
      trendHTML = this._renderTrend(row.trend);
    }

    return `
      <tr class="${rowClass}">
        <td class="ltc-col-pos">${pos != null && !isNaN(pos) ? pos : ""}</td>
        <td class="ltc-col-team">
          <span class="ltc-team-name">${teamName}</span>
        </td>
        <td class="ltc-col-m">${matches}</td>
        <td class="ltc-col-pkt">${points}</td>
        <td class="ltc-col-goals">${goals}</td>
        <td class="ltc-col-diff">${diffStr}</td>
        ${
          cfg.show_trend
            ? `<td class="ltc-col-trend">${trendHTML}</td>`
            : ""
        }
      </tr>
    `;
  }

  _renderTrend(trend) {
    if (!trend) return "";

    const t = String(trend).toLowerCase().trim();

    if (t === "up" || t === "+" || t === "↑" || t === "▲") {
      return `<span class="ltc-trend-up">▲</span>`;
    }
    if (t === "down" || t === "-" || t === "↓" || t === "▼") {
      return `<span class="ltc-trend-down">▼</span>`;
    }
    if (t === "same" || t === "0" || t === "=" || t === "→") {
      return `<span class="ltc-trend-same">━</span>`;
    }

    return `<span>${trend}</span>`;
  }

  static getConfigElement() {
    return document.createElement("league-table-card-editor");
  }

  static getStubConfig() {
    return {
      entity: "sensor.90minut_gornik_zabrze_table",
    };
  }

  getCardSize() {
    return 5;
  }
}

if (!customElements.get("league-table-card")) {
  customElements.define("league-table-card", LeagueTableCard);
}

window.customCards = window.customCards || [];
window.customCards.push({
  type: "league-table-card",
  name: "League Table Card (90minut)",
  description: "Tabela ligowa na podstawie sensora 90minut.pl",
});