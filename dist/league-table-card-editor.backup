// ============================================================================
//  League Table Card Editor (90minut)
//  - Vanilla JS (bez lit)
//  - Sekcje: Podstawowe / Styl wierszy / Podświetlenia / Czcionki
//  - Debounce dla pól liczbowych/tekstowych (~700 ms)
// ============================================================================

class LeagueTableCardEditor extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: "open" });
    this._config = {};
    this._debounce = null;
  }

  // ------------------------------------------------
  //  HA wywołuje setConfig z aktualnym YAML-em
  // ------------------------------------------------
  setConfig(config) {
    const cfg = config || {};

    const defaults = {
      name: "Tabela ligowa",
      show_name: true,
      lite_mode: false,
      show_trend: true,
      fill_mode: "gradient", // gradient / zebra / clear
      font_size: {
        header: 0.8,
        row: 0.9,
        team: 1.0,
      },
      highlight: {
        favorite: true,
        top_count: 2,
        bottom_count: 3,
        top_color: "#3ba55d",    // LM
        conf_color: "#468cd2",   // LK
        bottom_color: "#e23b3b", // spadek
        alpha_start: 0.0,
        alpha_end: 0.55,
      },
      zebra_color: "#f0f0f0",
      zebra_alpha: 0.4,
    };

    // Głębokie scalanie z domyślnymi
    this._config = {
      ...defaults,
      ...cfg,
      font_size: { ...defaults.font_size, ...(cfg.font_size || {}) },
      highlight: { ...defaults.highlight, ...(cfg.highlight || {}) },
    };

    if (typeof this._config.fill_mode !== "string") {
      this._config.fill_mode = "gradient";
    }

    this._render();
  }

  // ------------------------------------------------
  //  Debounce + wysyłanie config-changed
  // ------------------------------------------------
  _scheduleApply(immediate = false) {
    if (immediate) {
      clearTimeout(this._debounce);
      this._apply();
      return;
    }

    clearTimeout(this._debounce);
    this._debounce = setTimeout(() => this._apply(), 700);
  }

  _apply() {
    const ev = new CustomEvent("config-changed", {
      detail: { config: this._config },
      bubbles: true,
      composed: true,
    });
    this.dispatchEvent(ev);
  }

  // ------------------------------------------------
  //  Aktualizacje configu
  // ------------------------------------------------
  _updateRoot(key, value, immediate = false) {
    this._config = {
      ...this._config,
      [key]: value,
    };
    this._scheduleApply(immediate);
  }

  _updateNested(group, key, value, immediate = false) {
    const nested = { ...(this._config[group] || {}) };
    nested[key] = value;
    this._config = {
      ...this._config,
      [group]: nested,
    };
    this._scheduleApply(immediate);
  }

  // ------------------------------------------------
  //  Render UI
  // ------------------------------------------------
  _render() {
    if (!this.shadowRoot) return;
    const c = this._config;

    this.shadowRoot.innerHTML = `
      <style>
        .group {
          margin: 12px 0;
          border-radius: 8px;
          border: 1px solid rgba(255,255,255,0.15);
          overflow: hidden;
        }

        .group summary {
          padding: 10px 12px;
          font-size: 1rem;
          cursor: pointer;
          background: rgba(255,255,255,0.05);
        }

        .group > div {
          padding: 10px 16px 18px 16px;
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 12px;
        }

        label {
          display: flex;
          flex-direction: column;
          font-size: 0.85rem;
          opacity: 0.9;
        }

        input[type="number"],
        input[type="text"],
        select {
          margin-top: 4px;
          padding: 4px 6px;
          border-radius: 6px;
          border: 1px solid rgba(255,255,255,0.20);
          background: rgba(0,0,0,0.2);
          color: inherit;
        }

        input[type="color"] {
          margin-top: 4px;
          width: 40px;
          height: 28px;
          padding: 0;
          border: none;
          background: transparent;
        }

        .switch-row {
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 0.9rem;
        }

        .switch-row span {
          opacity: 0.9;
        }

        .legend-hint {
          font-size: 0.8rem;
          opacity: 0.7;
          grid-column: 1 / -1;
          margin-top: 4px;
        }
      </style>

      <!-- PODSTAWOWE -->
      <details class="group" open>
        <summary>Podstawowe</summary>
        <div>
          <label>
            Nazwa karty
            <input type="text"
                   data-root-key="name"
                   value="${c.name ?? ""}">
          </label>

          <div class="switch-row">
            <ha-switch data-root-key="show_name" ${c.show_name !== false ? "checked" : ""}></ha-switch>
            <span>Pokaż nagłówek</span>
          </div>

          <div class="switch-row">
            <ha-switch data-root-key="lite_mode" ${c.lite_mode === true ? "checked" : ""}></ha-switch>
            <span>Tryb LITE (bez tła ha-card)</span>
          </div>

          <div class="switch-row">
            <ha-switch data-root-key="show_trend" ${c.show_trend !== false ? "checked" : ""}></ha-switch>
            <span>Pokaż kolumnę trendu</span>
          </div>
        </div>
      </details>

      <!-- STYL WIERSZY -->
      <details class="group">
        <summary>Styl wierszy (wypełnienie)</summary>
        <div>
          <label>
            Tryb wypełnienia
            <select data-root-key="fill_mode">
              <option value="gradient" ${c.fill_mode === "gradient" ? "selected" : ""}>Gradient</option>
              <option value="zebra" ${c.fill_mode === "zebra" ? "selected" : ""}>Zebra</option>
              <option value="clear" ${c.fill_mode === "clear" ? "selected" : ""}>Brak</option>
            </select>
          </label>

          ${c.fill_mode === "gradient" ? `
            <label>
              Start gradientu (%)
              <input type="number" min="0" max="100"
                     data-group="highlight" data-key="start"
                     value="${c.highlight?.start ?? 35}">
            </label>

            <label>
              Koniec gradientu (%)
              <input type="number" min="0" max="100"
                     data-group="highlight" data-key="end"
                     value="${c.highlight?.end ?? 100}">
            </label>

            <label>
              Alfa start
              <input type="number" min="0" max="1" step="0.05"
                     data-group="highlight" data-key="alpha_start"
                     value="${c.highlight?.alpha_start ?? 0}">
            </label>

            <label>
              Alfa koniec
              <input type="number" min="0" max="1" step="0.05"
                     data-group="highlight" data-key="alpha_end"
                     value="${c.highlight?.alpha_end ?? 0.55}">
            </label>
          ` : ""}

          ${c.fill_mode === "zebra" ? `
            <label>
              Kolor wierszy parzystych
              <input type="color"
                     data-root-key="zebra_color"
                     value="${c.zebra_color ?? "#f0f0f0"}">
            </label>

            <label>
              Alfa zebry
              <input type="number" min="0" max="1" step="0.05"
                     data-root-key="zebra_alpha"
                     value="${c.zebra_alpha ?? 0.4}">
            </label>
          ` : ""}
        </div>
      </details>

      <!-- PODŚWIETLENIA (STREFY) -->
      <details class="group">
        <summary>Strefy: LM / Liga Konferencji / Spadek</summary>
        <div>
          <div class="switch-row">
            <ha-switch data-group="highlight" data-key="favorite" ${c.highlight?.favorite !== false ? "checked" : ""}></ha-switch>
            <span>Pogrub moją drużynę</span>
          </div>

          <label>
            Drużyn w strefie "Liga Mistrzów"
            <input type="number" min="0" max="10"
                   data-group="highlight" data-key="top_count"
                   value="${c.highlight?.top_count ?? 2}">
          </label>

          <label>
            Drużyn w strefie spadkowej
            <input type="number" min="0" max="10"
                   data-group="highlight" data-key="bottom_count"
                   value="${c.highlight?.bottom_count ?? 3}">
          </label>

          <label>
            Kolor: "Liga Mistrzów"
            <input type="color"
                   data-group="highlight" data-key="top_color"
                   value="${c.highlight?.top_color ?? "#3ba55d"}">
          </label>

          <label>
            Kolor: "Liga Konferencji"
            <input type="color"
                   data-group="highlight" data-key="conf_color"
                   value="${c.highlight?.conf_color ?? "#468cd2"}">
          </label>

          <label>
            Kolor: "Spadek"
            <input type="color"
                   data-group="highlight" data-key="bottom_color"
                   value="${c.highlight?.bottom_color ?? "#e23b3b"}">
          </label>

          <div class="legend-hint">
            Legenda na dole tabeli korzysta z powyższych kolorów.
          </div>
        </div>
      </details>

      <!-- CZCIONKI -->
      <details class="group">
        <summary>Rozmiary czcionek</summary>
        <div>
          <label>
            Nagłówek tabeli
            <input type="number" step="0.1"
                   data-group="font_size" data-key="header"
                   value="${c.font_size?.header ?? 0.8}">
          </label>

          <label>
            Wiersze
            <input type="number" step="0.1"
                   data-group="font_size" data-key="row"
                   value="${c.font_size?.row ?? 0.9}">
          </label>

          <label>
            Nazwy drużyn
            <input type="number" step="0.1"
                   data-group="font_size" data-key="team"
                   value="${c.font_size?.team ?? 1.0}">
          </label>
        </div>
      </details>
    `;

    this._attachListeners();
  }

  // ------------------------------------------------
  //  Listeners po wstrzyknięciu HTML
  // ------------------------------------------------
  _attachListeners() {
    const root = this.shadowRoot;
    if (!root) return;

    // Top-level pola tekstowe/numeryczne/select
    root.querySelectorAll("input[data-root-key], select[data-root-key]").forEach((el) => {
      const key = el.getAttribute("data-root-key");
      if (!key) return;

      if (el.tagName.toLowerCase() === "ha-switch") {
        // u mnie i tak nie wejdzie, bo ha-switch ma osobny handler niżej
        return;
      }

      const isNumber = el.getAttribute("type") === "number";

      const handler = (evt) => {
        let val = isNumber ? Number(el.value) : el.value;
        if (isNumber && Number.isNaN(val)) {
          val = 0;
        }
        this._updateRoot(key, val, false);
      };

      el.addEventListener("input", handler);
    });

    // Top-level ha-switch
    root.querySelectorAll("ha-switch[data-root-key]").forEach((sw) => {
      const key = sw.getAttribute("data-root-key");
      if (!key) return;

      sw.addEventListener("change", () => {
        this._updateRoot(key, sw.checked, true);
      });
    });

    // Pólka zagnieżdżone (font_size, highlight, itp.)
    root.querySelectorAll("input[data-group][data-key], select[data-group][data-key]").forEach((el) => {
      const group = el.getAttribute("data-group");
      const key = el.getAttribute("data-key");
      if (!group || !key) return;

      const tag = el.tagName.toLowerCase();
      const isSwitch = tag === "ha-switch";
      const isNumber = el.getAttribute("type") === "number";

      if (isSwitch) {
        el.addEventListener("change", () => {
          this._updateNested(group, key, el.checked, true);
        });
      } else {
        const handler = () => {
          let val = isNumber ? Number(el.value) : el.value;
          if (isNumber && Number.isNaN(val)) {
            val = 0;
          }
          this._updateNested(group, key, val, false);
        };
        el.addEventListener("input", handler);
      }
    });
  }
}

customElements.define("league-table-card-editor", LeagueTableCardEditor);
